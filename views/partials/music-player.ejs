<!-- views/partials/music-player.ejs -->
<div id="music-player" class="music-player">
    <audio id="bgm" loop>
        <source src="/audio/bgm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <div class="music-controls">
        <button id="playBtn" class="btn btn-sm btn-outline-primary">
            â™« Play BGM
        </button>
        <button id="pauseBtn" class="btn btn-sm btn-outline-secondary" style="display: none;">
            âšâš Pause
        </button>
        <button id="muteBtn" class="btn btn-sm btn-outline-warning">
            ğŸ”‡ Mute
        </button>
        <span class="volume-control">
            <label>Volume:</label>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.5">
        </span>
    </div>
</div>

<style>
.music-player {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: 2px solid var(--primary-color);
    z-index: 1000;
    font-family: 'VT323', monospace;
}

.music-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.music-controls .btn {
    font-size: 0.9rem;
    padding: 4px 8px;
    border-radius: 5px;
}

.volume-control {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
}

.volume-control label {
    margin: 0;
    white-space: nowrap;
}

#volumeSlider {
    width: 80px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .music-player {
        bottom: 10px;
        right: 10px;
        left: 10px;
        padding: 8px 12px;
    }
    
    .music-controls {
        justify-content: center;
    }
    
    .volume-control {
        flex: 1;
        justify-content: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bgm = document.getElementById('bgm');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const muteBtn = document.getElementById('muteBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    
    // è®¾ç½®åˆå§‹éŸ³é‡
    bgm.volume = volumeSlider.value;
    
    // æ’­æ”¾æŒ‰é’®äº‹ä»¶
    playBtn.addEventListener('click', function() {
        bgm.play().catch(error => {
            console.log('Auto-play prevented:', error);
            // å¦‚æœè‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œæ˜¾ç¤ºç”¨æˆ·äº¤äº’æç¤º
            alert('Click the Play button to start background music!');
        });
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-block';
    });
    
    // æš‚åœæŒ‰é’®äº‹ä»¶
    pauseBtn.addEventListener('click', function() {
        bgm.pause();
        playBtn.style.display = 'inline-block';
        pauseBtn.style.display = 'none';
    });
    
    // é™éŸ³æŒ‰é’®äº‹ä»¶
    muteBtn.addEventListener('click', function() {
        bgm.muted = !bgm.muted;
        muteBtn.textContent = bgm.muted ? 'ğŸ”Š Unmute' : 'ğŸ”‡ Mute';
        muteBtn.classList.toggle('btn-outline-warning');
        muteBtn.classList.toggle('btn-outline-success');
    });
    
    // éŸ³é‡æ»‘å—äº‹ä»¶
    volumeSlider.addEventListener('input', function() {
        bgm.volume = volumeSlider.value;
    });
    
    // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¯èƒ½ä¼šè¢«æµè§ˆå™¨é˜»æ­¢ï¼‰
    const tryAutoPlay = () => {
        bgm.play().then(() => {
            playBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
        }).catch(error => {
            console.log('Auto-play was prevented:', error);
            // ä¿æŒæ’­æ”¾æŒ‰é’®å¯è§
            playBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
        });
    };
    
    // é¡µé¢åŠ è½½åå°è¯•è‡ªåŠ¨æ’­æ”¾
    setTimeout(tryAutoPlay, 1000);
    
    // å¤„ç†éŸ³é¢‘ç»“æŸäº‹ä»¶ï¼ˆç¡®ä¿å¾ªç¯ï¼‰
    bgm.addEventListener('ended', function() {
        bgm.currentTime = 0;
        bgm.play();
    });
    
    // ä¿å­˜éŸ³é‡è®¾ç½®åˆ° localStorage
    volumeSlider.addEventListener('change', function() {
        localStorage.setItem('bgmVolume', volumeSlider.value);
    });
    
    // åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
    const savedVolume = localStorage.getItem('bgmVolume');
    if (savedVolume) {
        volumeSlider.value = savedVolume;
        bgm.volume = savedVolume;
    }
});
</script>
